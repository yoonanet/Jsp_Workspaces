<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>자바스크립트로 Ajax 구현하기</title>

<!-- onload는 body영역을 다 읽어간 뒤에 발생하는 이벤트임 => 콜백함수(범용적으로 칭하는 용어)이다, 
                                                             자바스크립트에서 이벤트가 발생했을 때 등록해준 함수를 이벤트핸들러, 이벤트리스너함수라고 불러주고 있다. 
     (body영역을 다 읽어간 것은 브라우저가 먼저 알게 됨. 함수를 실행하면서 프로그래머가 읽어간 것을 확인할 수 있음) 
     
     ***자바스크립트에서 이벤트는 내가 함수를 등록하여 이벤트가 발생했을 때 함수를 호출해주는 구조로 제공해준다. -->
<script type="text/javascript">
window.onload = function(){	
	var xhr;
	
	//모든 브라우저에서 범용적으로 ajax의 기능들을 사용할 수 있도록 아래와 같은 코드를 작성하도록 한다.
	if(window.XMLHttpRequest){ //대부분의 브라우저에는 ajax의 자료형 이름을 XMLHttpRewuest로 정의함.
		xhr = new XMLHttpRequest();
	}else if(window.ActiveXObject){ //인터넷 익스플로러 8이하버전에서는 ajax의 자료형 이름을 ActiveXObject로 정의해주고 있음
		xhr = new ActiveXObject("Msxmi2.XMLHTTP"); //정보를 입력으로 넣어줘야 해당하는 ajax의 기능의 객체를 생성해서 반환해줌.
	}else{
		throw new Err("Ajax가 지원하지 않는 브라우저입니다.");
	}
	
/*  
onreadystatechange속성은 이벤트가 발생이 되어지는 속성의 필드이다. (on이라는 이름이 붙으면 이벤트에 관련된 기능임)
이벤트가 발생했을 때 뭔가를 하고 싶은 것이고, 이때 함수를 등록해주도록 한다. => 함수가 호출이 되었다는 것은 해당하는 이벤트가 발생이 되어진 것이다.
그렇다면 onreadystatechange는 어떤 이벤트가 발생했을 때 함수를 호출을 해주는 것일까?
onreadystatechange는 속성으로써 값이고, 단독으로 사용되어지는 개념이 아님. 속성중에 readyState와 긴밀한 연관이 있는 이벤트 속성이다.
readyState의 값이 변경될 때마다 발생되는 이벤트가 onreadystatechange인 것이다.

***ajax의 기술을 생각하면 비동기적인 부분 업데이트를 생각하도록 한다. (단편적인 매칭의 개념)
브라우저를 통해서 첫 메인페이지를 요청하고 로그인의 UI가 있다면 로그인을 하게 되면 이에 대한 정보가 서버쪽으로 넘겨주게 된다.
버튼이 눌렸을 때 정보가 전달되는 것이 첫번째인 것이다. -> 이때 ajax를 구동시켜줘야 하는 것이다.
ajax를 구동시키는 메소드가 open()이다. 예를 들어 submit을 누르면 form태그의 action에 지정한 값이 요청됨. 이처럼 준비단계에 관련된 메소드가 open()인 것이다. 
=> ajax가 동작될 구동 준비가 완료됨. 이때, 전송에 대한 준비가 완료될 때 ajax는 readyState값을 1로 셋팅을 해주게 된다.

***new를 하여 객체를 생성하는 순간에는 초기값이 0으로 셋팅이 되어져 있는 것이다. 그때 onreadystatechange에 등록한 함수가 호출됨!!
open()으로 ajax를 사용할 준비를 마치는 순간 1로 값을 업데이트 해주는 것이다. -> 0에서 1로 값이 바뀌기 때문에 onreadystatechange의 이벤트가 발생되는 것임

로그인 버튼이 눌리면 서버쪽으로 지금 요청사항을 전송해야함 -> send()메소드를 활용하도록 한다.
보내는 순간 readyState값을 2로 업데이트됨 -> onreadystatechange의 메소드가 또 호출됨

로그인에 대해 데이터를 비교하고 나서 응답 처리를 위해 브라우저가 데이터를 전달받기 시작할 때 데이터가 오는 것을 감지한 순간에 readyState는 3으로 값을 셋팅해주게 된다.
서버로 부터 모든 데이터가 전달되어지면 readyState은 최종적으로 4로 셋팅이 되어진다. 그렇게 값이 변화될 때마다 이벤트가 발생이 되어지는 것이고, 그때 등록한 함수가 호출되어지는 것이다.
=> 3에서 4로의 변화는 아주 짧은 시간에 일어남!!

상태에 따라서 readyState의 값은 0, 1, 2, 3, 4로 가지게 되는 것이다.
값이 변화될 때마다 onreadystatechange가 이벤트를 발생시키는 것이고, 이벤트가 발생할 때 함수를 등록해두면 되는 것이다.
함수를 등록하는 이유는 요청을 보낸 후에 제대로 서버로부터 응답을 받았는지에 대한 체크를 하기 위함이다!!
(즉, 서버로부터 제대로 응답을 받았는지에 대해 체크하기 위해서 readyState필드 값을 통해 onreadystatechange의 이벤트핸들러를 연결하여 확인하도록 한다.)

ex. 유튜브의 화면구성에서는 페이지를 완성해서 보내주지 않음. 최소의 데이터정보만 전달받고 화면을 구성함. 그렇게 자바스크립트 화면으로 구성하도록 하는 것이다.
    이럴때 ajax의 기술이 활용이 되는 것이다.
    
    즉, ajax에서의 요청을 받아서 응답을 보내주는 것은 대부분 응답을 보낼 데이터만 구성하는 것이 일반적임!!
*/	

	xhr.onreadystatechange = function(){
		if(xhr.readyState == 4) { //비동기적(send())으로 요청을 보냈을 때 서버가 데이터를 보내오는데 이때 데이터를 다 받은 상태인 4번일 때 기능을 부여하도록 한다.
			//서버로부터 전달받은 데이터가 정상적으로 받아졌는지, 에러가 발생했는지를 서버가 응답을 보내오면서 에러 번호값을 같이 받아오게 된다.
			//정상적일 때는 200~300사이에 번호값을 보내오게 된다. => 그렇게 서버가 보내온 에러와 정상동작 번호 값을 자바스크립트는 자신이 가지고 있는 status속성에 저장해놓는 것이다.
			//status속성: 서버로부터 전달받은 상태정보를 저장해놓는다. (에러가 났는지 정상적으로 실행이 됐는지에 대한 상태정보 저장!!)
			if(xhr.status >= 200 && xhr.status < 300) {
				
				document.getElementById('container').innerHTML = xhr.responseText; //innerHTML속성은 등호가 없을 때는 텍스트노드를 읽어오는 것이고, 등호를 넣어주면 id에 값을 출력해주는 기능이였음
				//responseText: 텍스트로 전달받은 데이터를 보관하는 필드임.
			}
		}
	}; 
	
	xhr.open('get', 'resource.html'); //전송방식에 대한 설정을 첫번째 매개변수의 입력으로 넣어주도록 한다, 두번째 매개변수에는 요청할 응답 페이지를 정보 셋팅(이에 대한 정보들이 셋팅 되어지는 순간 1이됨.)
	
	setTimeout(function(){
		xhr.send(); //서버로 요청사항을 전달하는 기능 => 이때 2로 바뀌고 서버에 요청이 보내지고, 서버에 값이 보내오면서 값이 계속 업데이트될 것이다.
	}, 5000);
		
};
</script>

</head>
<body>

	<!-- 로그인이 되면 입력양식태그를 다 없애버리고 환영의 메시지를 출력하게끔 한다. -->
	<div id="container"></div>



<!-- 
Ajax는 웹표준에 포함되는 문법으로 Ajax는 Asynchronous(비동기) javaScript and XML의 약어임(포인트는 자바스크립트인 웹표준)
=> Asynchronous가 Ajax의 핵심 포인트이다. (***Ajax기술은 jsp가 아닌 자바의 기술이다!!)

로그인 화면에서 아이디와 비밀번호를 넣고 로그인버튼을 누르면 로그인에 성공하면 응답으로 보낼 jsp파일이 있을 것임 
 - 같은 화면에 00님 환영합니다의 인폼을 가지고 보여질 것임
동일한 화면에서 일정 구역만 바뀌게 되는데 전체의 페이지로 인폼을 보내는 것은 비효율적임. 
 => 동기방식임(클라이언트에서 요청하면 새로운 페이지를 응답으로 보내주는 처리, 또는 새로운 페이지를 sendRedirect했었음)

로그인할 때 받은 페이지는 그대로 유지하면서 일정 구역만 업데이트되게끔 하는 것이 효율적이다. 
즉, 이미 응답으로 보낸 화면에서 비동기적으로 부분적인 업데이트만으로 처리하는 기술이 Ajax인 것이다. 
(새로운 화면으로만 응답하지 않고 부분적인 이벤트처리에 의해서 부분적인 처리를 비동기적으로 결과를 피드백받도록 한다.)
 => 대표적으로 로그인 화면(항상 준비가 되어야 하는 화면이 로그인이고, 그 화면은 메인과 별도로 구성되도록 한다.)

자바스크립트가 화면에 동적효과를 부여할 수 있는 프로그래밍 언어였고, 일부분을 수정하는 것도 가능하게 하는 것임.
즉, Ajax는 자바스크립트의 문법기반으로 동작이 되어지는 기술이다.

클라이언트가 화면을 요청을 했을 때 서버는 그 화면을 어떤식으로 준비를 하고 있어야 하는가? 
양이 있는 데이터라고 할 때, 일반적으로 통신프로토콜 기반해서 XML표준, JSON표준을 이용해서 데이터를 주고받게끔 처리하는 것이 일반적이다.
XML, JSON은 웹간에 데이터를 주고받고자할 때 데이터는 어떠한 포맷으로 주고 받고자 하는 약속되어져 있는 표준을 말한다.
            (!!네트워크상에 데이터를 주고받기 위한 표준!!)
***Ajax는 XMLHttpRequest(XHR) 객체로 제공을 해주고 있음 (이름은 웹서비스의 Request임. 그렇기 때문에 jsp에서 배우는 것이다.)
   객체지향으로써 위 객체는 자바스크립트 안에서 필드와 메소드를 제공해준다.
   
body영역을 다 읽어간 이후에 액션을 취하도록 한다. => window.onload를 활용 
***자바스크립트에서는 이벤트가 발생했을 때 등록해주는 함수(콜백함수)를 이벤트핸들러 혹은 이벤트리스너로 불러주고 있었음
 --> 
</body>
</html>

